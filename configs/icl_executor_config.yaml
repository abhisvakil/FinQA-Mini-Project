# ICL with Enhanced Executor Configuration for FinQA
# Optimized for A100 GPU

model:
  model_name_or_path: "mistralai/Mistral-7B-Instruct-v0.2"
  torch_dtype: "bfloat16"  # Use BF16 for A100
  device_map: "auto"  # Automatically use GPU
  load_in_8bit: false

generation:
  max_new_tokens: 256
  temperature: 0.2
  top_p: 0.95
  top_k: 50
  do_sample: true
  num_beams: 1
  repetition_penalty: 1.1

# Executor configuration
executor:
  enabled: true
  max_retries: 2  # Allow up to 2 retries (3 total attempts)
  validate_results: true
  provide_feedback: true
  
  # Only retry on specific error types
  retry_on_errors:
    - "parse_error"
    - "execution_error"
    - "validation_warning"
  
  # Skip retry for these
  skip_retry_on:
    - "empty_program"

# System prompt with clear instructions
system_prompt: |
  You are a financial calculator. Generate a PROGRAM to solve the question.
  
  CRITICAL RULES:
  1. Use ONLY these operations: add, subtract, multiply, divide, greater, exp
  2. Use ONLY actual numbers from the data (like 750, 500, 0.14)
  3. For multi-step: separate with commas, use #0, #1, etc. for previous results
  4. Output MUST be EXACTLY: "Program: your_code" then "Answer: number"
  5. NO explanations, NO text, NO undefined variables
  
  COMMON PATTERNS:
  - Percentage change: subtract(new, old), divide(#0, old), multiply(#1, 100)
  - Ratio/portion: divide(part, total)
  - Comparison: greater(value1, value2)
  - Net change: subtract(later, earlier)
  
  WRONG ❌:
    Program: To find the percentage...
    Program: divide(total_facilities, 56.0)
    Program: add(#2, #3)  [when #2 doesn't exist yet]
  
  CORRECT ✅:
    Program: subtract(750, 500), divide(#0, 500), multiply(#1, 100)
    Program: divide(8.1, 56.0)
    Program: subtract(153.7, 139.9), divide(#0, 139.9)
  
  Format:
    Program: operation(num1, num2), operation(#0, num3)
    Answer: final_number

# Prompt template
prompt_template: |
  {system_prompt}
  
  EXAMPLES:
  
  Q: What is the percentage change from 500 to 750?
  Program: subtract(750, 500), divide(#0, 500), multiply(#1, 100)
  Answer: 50.0
  
  Q: What is 8.1 divided by 56?
  Program: divide(8.1, 56.0)
  Answer: 0.14464
  
  Q: What is the net change from 5735 to 5829?
  Program: subtract(5829, 5735)
  Answer: 94.0
  
  Q: Is 286.61 greater than 198.09?
  Program: greater(286.61, 198.09)
  Answer: yes
  
  {few_shot_examples}
  
  Now solve this question:
  
  Question: {question}
  
  Context:
  {context}
  
  Program:

# Data configuration
data:
  test_file: "src/data/test.json"
  output_file: "results/icl_executor_predictions.json"
  max_samples: 50  # Start with 10 for testing, set to null for all

# Inference settings
inference:
  batch_size: 1  # Process one at a time for now (can increase for batching)
  use_cache: true
  save_intermediate: true
  log_attempts: true  # Log all retry attempts

